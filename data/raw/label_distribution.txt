"""
æ•°æ®é›†æ ‡ç­¾åˆ†å¸ƒåˆ†ææŠ¥å‘Š
========================

æ•°æ®æ–‡ä»¶: aggregate_datas_label.jsonl
ç”Ÿæˆæ—¶é—´: 2024-02-02
"""

import json
from pathlib import Path
from collections import Counter

def analyze_label_distribution():
    data_file = Path('data/raw/aggregate_datas_label.jsonl')

    data = []
    with open(data_file, 'r', encoding='utf-8') as f:
        for line in f:
            if line.strip():
                item = json.loads(line.strip())
                labels = item.get('label', [0, 0])
                data.append({
                    'text': item.get('statement', ''),
                    'necessity': labels[0],
                    'clarity': labels[1] if len(labels) > 1 else 0,
                    'labels': labels
                })

    print("=" * 80)
    print("ğŸ“Š å°ç¨‹åºéšç§å£°æ˜æ•°æ®é›† - æ ‡ç­¾åˆ†å¸ƒåˆ†ææŠ¥å‘Š")
    print("=" * 80)
    print(f"\næ€»æ•°æ®é‡: {len(data)} æ¡\n")

    # ç»Ÿè®¡æ ‡ç­¾ç»„åˆ
    label_combinations = Counter((d['necessity'], d['clarity']) for d in data)

    print("ğŸ·ï¸  æ ‡ç­¾ç»„åˆåˆ†å¸ƒ:")
    print("-" * 80)
    print(f"{'ç±»åˆ«':<30} {'æ ‡ç­¾':<15} {'æ•°é‡':>8} {'å æ¯”':>10} {'åˆ†å¸ƒå›¾'}")
    print("-" * 80)

    for (necessity, clarity), count in label_combinations.most_common():
        percentage = count / len(data) * 100
        label_str = f"({necessity}, {clarity})"

        if necessity == 0 and clarity == 0:
            category = "âœ… æ— è¿è§„"
        elif necessity == 1 and clarity == 0:
            category = "âš ï¸  ä»…å¿…è¦æ€§è¿è§„"
        elif necessity == 0 and clarity == 1:
            category = "âš ï¸  ä»…æ¸…æ™°æ€§è¿è§„"
        elif necessity == 1 and clarity == 1:
            category = "âŒ åŒé‡è¿è§„"
        else:
            category = "æœªçŸ¥"

        bar = 'â–ˆ' * int(percentage / 2)
        print(f"{category:<30} {label_str:<15} {count:>8} {percentage:>9.2f}% {bar}")

    print("\n" + "=" * 80)
    print("ğŸ“ˆ å•ç‹¬ï¿½ï¿½ï¿½åº¦ç»Ÿè®¡")
    print("=" * 80)

    # å•ç‹¬ç»Ÿè®¡æ¯ä¸ªç»´åº¦
    necessity_violations = sum(1 for d in data if d['necessity'] == 1)
    clarity_violations = sum(1 for d in data if d['clarity'] == 1)
    no_violations = sum(1 for d in data if d['necessity'] == 0 and d['clarity'] == 0)

    print(f"\nâœ… æ— è¿è§„ (0, 0):           {no_violations:4} æ¡ ({no_violations/len(data)*100:5.2f}%)")
    print(f"âš ï¸  å­˜åœ¨å¿…è¦æ€§è¿è§„ (1,*):     {necessity_violations:4} æ¡ ({necessity_violations/len(data)*100:5.2f}%)")
    print(f"âš ï¸  å­˜åœ¨æ¸…æ™°æ€§è¿è§„ (*,1):     {clarity_violations:4} æ¡ ({clarity_violations/len(data)*100:5.2f}%)")

    print("\n" + "=" * 80)
    print("ğŸ“Š æ•°æ®é›†ç‰¹å¾")
    print("=" * 80)

    has_violations = sum(1 for d in data if d['necessity'] == 1 or d['clarity'] == 1)
    print(f"\næœ‰è¿è§„çš„æ•°æ®:     {has_violations:4} æ¡ ({has_violations/len(data)*100:5.2f}%)")
    print(f"æ— è¿è§„çš„æ•°æ®:     {no_violations:4} æ¡ ({no_violations/len(data)*100:5.2f}%)")

    # ç±»åˆ«å¹³è¡¡æ€§åˆ†æ
    print("\n" + "-" * 80)
    print("âš–ï¸  ç±»åˆ«å¹³è¡¡æ€§åˆ†æ:")
    print("-" * 80)

    max_count = max(label_combinations.values())
    min_count = min(label_combinations.values())
    imbalance_ratio = max_count / min_count

    print(f"æœ€å¤šç±»åˆ«æ ·æœ¬æ•°: {max_count} æ¡")
    print(f"æœ€å°‘ç±»åˆ«æ ·æœ¬æ•°: {min_count} æ¡")
    print(f"ä¸å¹³è¡¡æ¯”ä¾‹: {imbalance_ratio:.2f}:1")

    if imbalance_ratio < 1.5:
        balance_status = "âœ… éå¸¸å¹³è¡¡"
    elif imbalance_ratio < 2.0:
        balance_status = "âœ… åŸºæœ¬å¹³è¡¡"
    elif imbalance_ratio < 3.0:
        balance_status = "âš ï¸  è½»å¾®ä¸å¹³è¡¡"
    else:
        balance_status = "âŒ ä¸¥é‡ä¸å¹³è¡¡"

    print(f"å¹³è¡¡çŠ¶æ€: {balance_status}")

    # æ•°æ®æ ·æœ¬ç¤ºä¾‹
    print("\n" + "=" * 80)
    print("ğŸ“ æ•°æ®æ ·æœ¬ç¤ºä¾‹")
    print("=" * 80)

    for (necessity, clarity), _ in label_combinations.most_common():
        # æ‰¾åˆ°è¯¥ç±»åˆ«çš„ç¬¬ä¸€ä¸ªæ ·æœ¬
        for item in data:
            if item['necessity'] == necessity and item['clarity'] == clarity:
                label_name = f"({necessity}, {clarity})"
                print(f"\nã€æ ‡ç­¾ {label_name}ã€‘")
                text = item['text'][:100] + "..." if len(item['text']) > 100 else item['text']
                print(f"æ–‡æœ¬: {text}")
                break

    print("\n" + "=" * 80)
    print("âœ… åˆ†æå®Œæˆ")
    print("=" * 80)

    # è¿”å›ç»Ÿè®¡ç»“æœ
    return {
        'total': len(data),
        'combinations': dict(label_combinations),
        'necessity_violations': necessity_violations,
        'clarity_violations': clarity_violations,
        'no_violations': no_violations,
        'has_violations': has_violations,
        'imbalance_ratio': imbalance_ratio
    }

if __name__ == "__main__":
    stats = analyze_label_distribution()
